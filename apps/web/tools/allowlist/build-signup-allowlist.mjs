import { createHash } from 'node:crypto'
import { mkdir, readFile, writeFile } from 'node:fs/promises'
import path from 'node:path'

function normalizeEmail(email) {
  return email.trim().toLowerCase()
}

function parseEmailsFromRaw(text) {
  const emails = new Set()
  const lines = text.split('\n')

  for (const rawLine of lines) {
    const line = rawLine.split('#')[0]?.trim() ?? ''
    if (!line) continue

    const tokens = line.split(/[,\s]+/)
    for (const token of tokens) {
      if (!token.includes('@')) continue
      emails.add(normalizeEmail(token))
    }
  }

  return [...emails].sort()
}

function hashEmail(email) {
  return createHash('sha256').update(email).digest('hex')
}

async function buildAllowlist() {
  const inputRelativePath = process.argv[2] ?? 'tools/allowlist/signup-allowlist.raw.txt'
  const outputRelativePath = process.argv[3] ?? 'public/signup-allowlist.txt'
  const inputPath = path.resolve(process.cwd(), inputRelativePath)
  const outputPath = path.resolve(process.cwd(), outputRelativePath)

  const rawText = await readFile(inputPath, 'utf8')
  const emails = parseEmailsFromRaw(rawText)

  if (emails.length === 0) {
    throw new Error('No email entries found in raw allowlist.')
  }

  const hashedEntries = emails.map((email) => `sha256:${hashEmail(email)}`)
  const outputText =
    '# Auto-generated signup allowlist (SHA-256 hashes)\n' +
    '# Generated by: npm run allowlist:build\n' +
    '# Source file keeps plain emails outside public assets.\n' +
    hashedEntries.join('\n') +
    '\n'

  await mkdir(path.dirname(outputPath), { recursive: true })
  await writeFile(outputPath, outputText, 'utf8')

  console.log(`Built ${hashedEntries.length} allowlist entries:`)
  console.log(`- input:  ${inputPath}`)
  console.log(`- output: ${outputPath}`)
}

buildAllowlist().catch((error) => {
  console.error('[allowlist:build] failed:', error instanceof Error ? error.message : error)
  process.exitCode = 1
})
